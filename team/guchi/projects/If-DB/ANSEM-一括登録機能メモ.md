---
tags: [ANSEM, database, feature, bulk-import, memo]
created: 2026-02-12
updated: 2026-02-12
status: draft
related: "[[ANSEM-ER図]], [[ANSEM-データ投入運用方針]], [[ANSEM-追加機能ロードマップ]]"
---

# ANSEM 一括登録機能メモ

> [!NOTE]
> DB設計（v5.4.0）は完了済み。ここから先は**アプリ機能**の話。
> 依頼元: 一括登録用スプシフォーマット作成 + 重複防止の仕組み検討

---

## 現状の課題

- 既存スプシのIFマスタに乖離・重複が多い
- 非エンジニアがDBに直接データ投入するのは現実的でない（ID参照・FK依存順など）
- スプシからの移行にあたり「やさしいフォーマット」＋「変換の仕組み」が必要

---

## 方針

```
運用担当が書くスプシ（人間語）
    ↓ 変換（バリデーション + ID解決 + 重複チェック）
DB投入（機械語）
```

| フェーズ | 方式 | 対象者 |
|---------|------|--------|
| Phase 1（初期投入） | エンジニアが直接SQL投入 | エンジニア |
| Phase 2（MVP運用） | やさしいスプシ＋変換スクリプト | 運用担当 |
| Phase 3（本番） | 管理画面（WebUI）で登録 | 全員 |

---

## 1. 一括登録の対象テーブル一覧と投入順

### 投入順序（FK依存順）

| 順番 | テーブル | 日本語名 | 投入方式 | 備考 |
|------|---------|---------|---------|------|
| ① | m_countries | 国マスタ | エンジニア初期投入 | ISO準拠、変更なし |
| ② | m_departments | 部署マスタ | エンジニア初期投入 | 社内組織、少量 |
| ③ | m_categories | カテゴリマスタ | エンジニア初期投入 | ジャンル分類、少量 |
| ④ | m_agent_role_types | 役割マスタ | エンジニア初期投入 | 固定値、少量 |
| ⑤ | m_sns_platforms | SNSプラットフォーム | エンジニア初期投入 | YouTube/Instagram等、固定 |
| ⑥ | m_agents | エージェント | エンジニアor管理画面 | 社内メンバー、少量 |
| ⑦ | m_clients | クライアント | **一括登録対象** | 広告主企業 |
| ⑧ | m_ad_groups | 広告グループ | **一括登録対象** | 広告の大分類 |
| ⑨ | **m_influencers** | **インフルエンサー** | **一括登録対象（最優先）** | 最大データ量。既存スプシからの移行 |
| ⑩ | m_partners | パートナー | **一括登録対象** | ASP・配信パートナー |
| ⑪ | m_ad_contents | 広告コンテンツ | **一括登録対象** | 広告素材 |
| ⑫ | m_partners_division | パートナー区分 | エンジニアorスクリプト | IF卸/TM区分。m_partnersと同時 |
| ⑬ | t_partner_sites | パートナーサイト | **一括登録対象** | パートナーのサイト |
| ⑭ | t_influencer_sns_accounts | SNSアカウント | **一括登録対象** | IFのSNS情報 |
| ⑮ | m_campaigns | キャンペーン | **一括登録対象** | site×IF×platform |

> [!IMPORTANT]
> 最優先は **m_influencers**。既存スプシからの移行で乖離が多いため、バリデーション＋重複チェック付きで対応。

---

## 2. 入力フォーマット（m_influencers）

### 運用担当が入力する列

| スプシ列名（日本語） | DBカラム | 型 | 入力方式 | 必須 |
|---------------------|----------|-----|---------|------|
| IF名 | influencer_name | TEXT | 自由入力 | |
| 活動名 | influencer_alias | TEXT | 自由入力 | |
| メールアドレス | email_address | TEXT | 自由入力 | |
| 電話番号 | phone_number | TEXT | 自由入力 | |
| 敬称 | honorific | TEXT | ドロップダウン（様/さん等） | |
| 所属名 | affiliation_name | TEXT | 自由入力 | |
| 所属タイプ | affiliation_type_id | SMALLINT | ドロップダウン（事務所所属/フリーランス/企業専属） | |
| 国 | country_id | SMALLINT | ドロップダウン（日本/アメリカ/韓国...） | |
| ステータス | status_id | SMALLINT | ドロップダウン（契約中/休止中/契約終了） | |
| コンプラ確認 | compliance_check | BOOLEAN | ○/× | |
| 取引開始同意 | start_transaction_consent | BOOLEAN | ○/× | |
| プライバシー同意 | privacy_consent | BOOLEAN | ○/× | |

### スクリプトが自動生成する列

| DBカラム | 生成ルール |
|----------|----------|
| influencer_id | IDENTITY（DB自動採番） |
| login_id | ルールベースで自動生成（例: IF-00001） |
| version | 1（固定） |
| created_by / updated_by | インポート実行者のagent_id |
| created_at / updated_at | CURRENT_TIMESTAMP |

### ドロップダウン値の対応表

```
【所属タイプ】
  事務所所属 → 1
  フリーランス → 2
  企業専属 → 3

【ステータス】
  契約中 → 1
  休止中 → 2
  契約終了 → 3

【国（主要）】
  日本 → 392
  アメリカ → 840
  韓国 → 410
  タイ → 764
  （m_countriesマスタに準拠）
```

---

## 3. 重複防止アイデア

### 現状の問題

- 同一IFが複数レコードとして登録されている（会議で確認済み）
- 原因: 請求先変更、SNS違い、所属変更などで新規登録してしまう
- 完全自動統合は困難（グループYouTuber問題等）→ **手動削除方針**に決定済み

### アイデア一覧

#### A. DB層（既に実装済み）

| 対策 | 実装状況 | 効果 |
|------|---------|------|
| login_id UNIQUE制約 | ✅ 実装済み | 同一login_idの重複を完全防止 |
| is_primary 部分UNIQUE | ✅ 実装済み | メイン住所・口座の重複防止 |

#### B. インポート時バリデーション（変換スクリプトに組み込み）

| 対策 | 実装コスト | 効果 |
|------|-----------|------|
| **名前完全一致チェック** | 低 | 同名の既存IFがいたら警告 |
| **メールアドレス重複チェック** | 低 | 同一メールの既存IFがいたら警告 |
| **電話番号重複チェック** | 低 | 同一電話番号の既存IFがいたら警告 |
| **SNS URL重複チェック** | 中 | t_influencer_sns_accountsと照合 |
| **名前あいまい検索** | 中 | カナ揺れ・半角全角・スペース有無を正規化して比較 |
| **口座情報重複チェック** | 中 | 同一口座の既存IFがいたら警告（事務所所属者は除外） |

#### C. アプリ機能（管理画面に実装）

| 対策 | 実装コスト | 効果 |
|------|-----------|------|
| **登録前サジェスト** | 中 | 名前入力中に類似IFを表示 |
| **重複候補リスト画面** | 中 | 定期的に重複候補を一覧表示→管理者が確認 |
| **承認フロー** | 高 | 新規登録→管理者承認→本登録の2段階 |
| **マージUI** | 高 | 重複レコードを選択→統合先を選んで手動マージ |

#### D. 運用プロセス（ルールで防ぐ）

| 対策 | 実装コスト | 効果 |
|------|-----------|------|
| **登録前チェックシート** | なし | 「この人は既に登録済みですか？」の確認項目 |
| **週次重複チェックバッチ** | 低 | SQLで重複候補を抽出→Slack通知 |
| **命名規則の統一** | なし | 「田中 花子」の入力ルール（スペースの有無等） |

### おすすめの優先順位

```
【Phase 2（MVP）で実装】
  1. インポート時の名前・メール・電話番号重複チェック（B案）
  2. 週次重複チェックバッチ（D案）
  3. 登録前チェックシート（D案）

【Phase 3（本番）で実装】
  4. 登録前サジェスト（C案）
  5. 重複候補リスト画面（C案）
  6. マージUI（C案）← 最も工数大、後回し
```

---

## TODO

- [ ] m_influencers 用スプシテンプレート作成
- [ ] 変換スクリプト（Python）作成
- [ ] 他テーブルの入力フォーマット定義
- [ ] 重複防止アイデアをNotionにも記載
- [ ] 運用マニュアル作成

---

_作成: 2026-02-12_
_ステータス: ドラフト（チーム内レビュー待ち）_
